<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/perfil" text="Perfil"></ion-back-button>
    </ion-buttons>
    <ion-title>Historial de Compras</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Historial</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="historial-contenido">

    <!-- Resumen de estadísticas -->
    <ion-card class="estadisticas-card">
      <ion-card-header>
        <ion-title>
          <ion-icon name="receipt-outline"></ion-icon>
          Resumen de Compras
        </ion-title>
      </ion-card-header>
      <ion-card-content>
        <div class="estadisticas-grid">
          <div class="estadistica">
            <ion-text color="primary">
              <h3>{{ estadisticas.totalPedidos }}</h3>
            </ion-text>
            <p>Total de Pedidos</p>
          </div>

          <div class="estadistica">
            <ion-text color="success">
              <h3>{{ formatearPrecio(estadisticas.totalGastado) }}</h3>
            </ion-text>
            <p>Total Gastado</p>
          </div>

          <div class="estadistica">
            <ion-text color="tertiary">
              <h3>{{ estadisticas.pedidosEntregados }}</h3>
            </ion-text>
            <p>Entregados</p>
          </div>

          <div class="estadistica">
            <ion-text color="warning">
              <h3>{{ estadisticas.pedidosPendientes }}</h3>
            </ion-text>
            <p>En Proceso</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Filtros -->
    <ion-card class="filtros-card">
      <ion-card-content>
        <ion-segment
          [(ngModel)]="filtroActivo"
          (ionChange)="onFiltroChange($event)"
          class="filtros-segment">
          <ion-segment-button value="todos">
            <ion-label>Todos</ion-label>
          </ion-segment-button>
          <ion-segment-button value="pendientes">
            <ion-label>En Proceso</ion-label>
          </ion-segment-button>
          <ion-segment-button value="entregados">
            <ion-label>Entregados</ion-label>
          </ion-segment-button>
          <ion-segment-button value="cancelados">
            <ion-label>Cancelados</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

    <!-- Lista de pedidos -->
    <div class="pedidos-lista" *ngIf="!cargando">
      <ion-card
        *ngFor="let pedido of pedidosFiltrados; trackBy: trackByPedido"
        class="pedido-card">

        <!-- Header del pedido -->
        <ion-card-header class="pedido-header">
          <div class="header-info">
            <div class="pedido-numero">
              <ion-text color="dark">
                <h3>{{ pedido.numeroPedido }}</h3>
              </ion-text>
              <ion-note>{{ formatearFecha(pedido.fecha) }}</ion-note>
            </div>

            <div class="pedido-estado">
              <ion-chip [color]="obtenerColorEstado(pedido.estado)" class="estado-chip">
                <ion-label>{{ pedido.estado }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <div class="pedido-total">
            <ion-text color="primary">
              <h2>{{ formatearPrecio(pedido.total) }}</h2>
            </ion-text>
          </div>
        </ion-card-header>

        <!-- Contenido del pedido -->
        <ion-card-content>
          <!-- Items del pedido -->
          <div class="items-resumen">
            <ion-text color="medium">
              <p>
                <strong>{{ pedido.items.length }}</strong>
                producto{{ pedido.items.length > 1 ? 's' : '' }}:
              </p>
            </ion-text>

            <div class="items-lista">
              <span
                *ngFor="let item of pedido.items; let last = last"
                class="item-nombre">
                {{ item.carta.nombre }} ({{ item.cantidad }}){{ !last ? ', ' : '' }}
              </span>
            </div>
          </div>

          <!-- Información de envío -->
          <div class="info-envio" *ngIf="pedido.tracking">
            <ion-icon name="car-outline" color="primary"></ion-icon>
            <ion-text color="medium">
              <p>Tracking: <strong>{{ pedido.tracking }}</strong></p>
            </ion-text>
          </div>

          <!-- Descripción del estado -->
          <div class="descripcion-estado">
            <ion-text color="medium">
              <p>{{ obtenerDescripcionEstado(pedido.estado) }}</p>
            </ion-text>
          </div>

          <!-- Fechas importantes -->
          <div class="fechas-info" *ngIf="pedido.fechaEstimadaEntrega || pedido.fechaEntrega">
            <div *ngIf="pedido.fechaEntrega" class="fecha-item">
              <ion-icon name="checkmark-outline" color="success"></ion-icon>
              <ion-text color="success">
                <small>Entregado: {{ formatearFecha(pedido.fechaEntrega) }}</small>
              </ion-text>
            </div>

            <div *ngIf="!pedido.fechaEntrega && pedido.fechaEstimadaEntrega" class="fecha-item">
              <ion-icon name="time-outline" color="warning"></ion-icon>
              <ion-text color="warning">
                <small>Entrega estimada: {{ formatearFecha(pedido.fechaEstimadaEntrega) }}</small>
              </ion-text>
            </div>
          </div>

          <!-- Notas -->
          <div *ngIf="pedido.notas" class="pedido-notas">
            <ion-text color="medium">
              <p><em>{{ pedido.notas }}</em></p>
            </ion-text>
          </div>

          <!-- Acciones -->
          <div class="pedido-acciones">
            <ion-button
              fill="outline"
              size="small"
              (click)="onVerDetalle(pedido)">
              <ion-icon name="eye-outline" slot="start"></ion-icon>
              Ver Detalle
            </ion-button>

            <ion-button
              fill="outline"
              size="small"
              color="success"
              (click)="onReordenar(pedido)">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Reordenar
            </ion-button>

            <ion-button
              *ngIf="pedido.estado === 'Pendiente' || pedido.estado === 'Confirmado'"
              fill="outline"
              size="small"
              color="danger"
              (click)="onCancelarPedido(pedido)">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancelar
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="cargando" class="cargando">
      <ion-text>
        <h3>Cargando historial...</h3>
      </ion-text>
    </div>

    <!-- Sin pedidos -->
    <div *ngIf="!cargando && pedidosFiltrados.length === 0" class="sin-pedidos">
      <ion-text>
        <h3>No hay pedidos</h3>
        <p *ngIf="filtroActivo !== 'todos'">
          No tienes pedidos con el filtro seleccionado
        </p>
        <p *ngIf="filtroActivo === 'todos'">
          Aún no has realizado ninguna compra. ¡Explora nuestro catálogo!
        </p>
      </ion-text>

      <ion-button
        *ngIf="filtroActivo === 'todos'"
        expand="block"
        fill="outline"
        routerLink="/tabs/catalogo">
        Ir al Catálogo
      </ion-button>
    </div>
  </div>
</ion-content>
